---
date: 2025-05-03
categories:
  - gpu
  - FP
---
# NVIDIA CUDA 浮点运算与 FMA 笔记
<!-- more -->

## 1. IEEE 754 浮点标准简介
- 主流计算系统（包括 NVIDIA CUDA 架构）均实现 IEEE 754 浮点标准。
- 浮点数由三部分组成：符号位、指数位（带偏移）、尾数（有效数字）。
- 常用格式：float（32位）、double（64位）。
- 由于位数有限，许多实数无法精确表示，需舍入（常用舍入模式为“最近偶数”）。

## 2. 浮点运算与精度
- IEEE 754 标准规定了加、减、乘、除、平方根、FMA（融合乘加）、取余、转换、缩放、符号操作和比较等运算。
- 浮点运算不满足数学上的结合律、分配律等，运算顺序会影响结果。
- 示例：A+B+C 的运算顺序不同，舍入后结果可能不同。

## 3. Fused Multiply-Add（FMA，融合乘加）
- FMA 运算：一次性计算 rn(X×Y+Z)，只进行一次舍入，比单独乘法和加法更精确。
- 传统做法需两次舍入：rn(rn(X×Y)+Z)。
- FMA 可有效减少精度损失，尤其在“减法消元”场景（如 a²-b，a≈b）下。
- NVIDIA GPU（计算能力2.0及以上）硬件支持 FMA，CPU 通常不支持。

## 4. 向量点积精度示例
- 点积计算可用串行方法（分步乘加）、FMA方法（融合乘加）、并行归约方法。
- FMA 方法能提升最终结果的精度。

## 5. CUDA 浮点运算相关
- 计算能力2.0及以上的设备支持单/双精度 IEEE 754 运算和 FMA。
- CUDA 支持四种舍入模式：rn（最近偶数）、rz（向零）、ru（向正）、rd（向负）。
- 可用编译器参数控制精度与性能：
  - `-ftz={true|false}`：是否将非正规数 flush 为0。
  - `-prec-div={true|false}`、`-prec-sqrt={true|false}`：控制除法和平方根精度。
- 默认模式下，单精度运算支持正规舍入和非正规数。

## 6. CPU与GPU结果差异
- GPU支持硬件FMA，CPU通常不支持，导致结果可能不同。
- 并行归约、线程数等实现细节也会影响最终结果。
- 数学库（如 sin、cos）在不同平台实现不同，结果可能略有差异。

## 7. 编程建议
- 优先使用 FMA 运算，提升精度和性能。
- 对比 CPU/GPU 结果时需考虑实现细节和平台差异。
- 了解 GPU 计算能力，合理选择精度和运算方式。
- 利用 CUDA math 库函数，权衡性能与精度。

---
参考：[NVIDIA CUDA Floating Point Guide](https://docs.nvidia.com/cuda/floating-point/index.html)
